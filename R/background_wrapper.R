#' Estimates the background model from a set of DNA sequences
#'
#' Given a set of DNA sequences and an order, this function
#' estimates an order-d Markov model which is used to characterize
#' random DNA sequences.
#'
#'
#' @param seqs DNAStringSet
#' @param order Order of the Markov models that shall be used as the
#' background model. Default: order=1.
#'
#' @return A Background object
#'
#' @examples
#'
#' # Estimate an order-1 Markov model based from a set of sequences
#'
#' file=system.file("extdata","seq.fasta", package="motifcounter")
#' seqs=Biostrings::readDNAStringSet(file)
#' bg=readBackground(seqs,1)
#'
#' @export
readBackground=function(seqs, order=1) {
    if (class(seqs)!="DNAStringSet") {
        stop("seqs must be a DNAStringSet")
    }
    if (order<0) {
        stop("order must be a positive integer")
    }

    # collect k-mer frequencies from each individual sequence
    counts=lapply(seqs,function(seq,order) {
        # if sequence is too short, do not attempt to count
        if (length(seq)<order) {
            return(numeric(4^(order+1)))
        } else {
            counts=numeric(4^(order+1))
            return(.C("motifcounter_countfreq", toString(seq), length(seq),
                as.numeric(counts),as.integer(order),
            PACKAGE="motifcounter")[[3]])
        }
    }, order)
    counts=matrix(unlist(counts),4^(order+1), length(seqs))
    counts=apply(counts,1,sum)
    trans=numeric(4^(order+1))
    if (order==0) {
        station=numeric(4)
    } else {
        station=numeric(4^order)
    }
    dummy=.C("motifcounter_bgfromfreq", as.numeric(counts),
            as.numeric(station), as.numeric(trans),
            as.integer(order),PACKAGE="motifcounter")
    background=list(station=dummy[[2]],trans=dummy[[3]],
            counts=dummy[[1]],order=order)
    class(background)="Background"
    return (background)
}

#' Check valididity of Background model
#'
#' This function checks if the Background model is valid. The function throws
#' an error if the object does not represent a Background model.
#'
#' @param bg A Background object
#' @return None
#'
#' @examples
#'
#' seqfile=system.file("extdata","seq.fasta", package="motifcounter")
#' seqs=Biostrings::readDNAStringSet(seqfile)
#'
#' bg=readBackground(seqs,1)
#' backgroundValid(bg)
#'
#' @export
backgroundValid=function(bg) {
    if (class(bg)!="Background") {
        stop("bg must be a Background object.
            Use readBackground() to construct one.")
    }
    if(length(bg)!=4) {
        stop("bg must contain 4 elements.
            Use readBackground() to construct bg.")
    }
    if(length(bg$trans)!= 4^(bg$order+1)) {
        stop("bg$trans must contain 4^(order+1) elements")
    }
}
